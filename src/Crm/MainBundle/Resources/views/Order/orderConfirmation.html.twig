{% extends 'CrmMainBundle::layout.html.twig' %}

{% block content %}
    <div class="box">
        <h2>Оформление заявки - Шаг 2</h2>
    </div>

    <div class="box">
        <table>
            <form method="POST" action="{{ path('order_confirmation') }}">
                <tr><td colspan="2" class="empty-row" style="border-top: none;">Организация</td></tr>
                <tr>
                    <td class="label">Название организации<span class="required">*</span>:</td>
                    <td class="value">
                        <input name="phone" id="companyName" type="text" placeholder="">
                    </td>
                    <td class="companyNameStatus"></td>
                </tr>
                <tr>
                    <td class="label">Адрес организации<span class="required">*</span>:</td>
                    <td class="value">
                        <input name="companyZipcode" id="companyZipcode"  type="text" placeholder="Индекс"><br />
                        <input name="companyRegion"  id="companyRegion"   type="text" placeholder="регион"><br />
                        <input name="companyCity"    id="companyCity"     type="text" placeholder="Город"><br />
                        <input name="companyStreet"  id="companyStreet"   type="text" placeholder="Улица"><br />
                        <input name="companyHouse"   id="companyHouse"    type="text" placeholder="Дом" class="little">
                        <input name="companyCorp"    id="companyCorp"     type="text" placeholder="Корп /Стр"  class="little">
                        <input name="companyRoom"    id="companyRoom"     type="text" placeholder="Кв / оф"  class="little">
                    </td>
                    <td class="companyAdressStatus"></td>
                </tr>

                <tr><td colspan="2" class="empty-row">Информация о доставке</td></tr>
                <tr>
                    <td class="label">Адрес доставки<span class="required">*</span>:</td>
                    <td class="value">
                        <input name="deliveryZipcode" id="deliveryZipcode" type="text" placeholder="Индекс"><br />
                        <input name="deliveryRegion"  id="deliveryRegion"  type="text" placeholder="регион"><br />
                        <input name="deliveryCity"    id="deliveryCity"    type="text" placeholder="Город"><br />
                        <input name="deliveryStreet"  id="deliveryStreet"  type="text" placeholder="Улица"><br />
                        <input name="deliveryHouse"   id="deliveryHouse"   type="text" placeholder="Дом" class="little">
                        <input name="deliveryCorp"    id="deliveryCorp"    type="text" placeholder="Корп /Стр"  class="little">
                        <input name="deliveryRoom"    id="deliveryRoom"    type="text" placeholder="Кв / оф"  class="little">
                    </td>
                    <td class="deliveryAdressStatus"></td>
                </tr>

                <tr><td colspan="2" class="empty-row">Другая информация</td></tr>
                <tr>
                    <td class="label">Номер прошлой карты:</td>
                    <td class="value">
                        <input name="oldNumber" id="oldNumber" type="text"  >
                    </td>
                    <td class="oldNumberStatus"></td>
                </tr>

                <tr><td colspan="2"><br /></td></tr>
                <tr>
                    <td style="text-align: right" colspan="2">
                        Я принимаю <a href="{{ path('page',{'url' : 'eula'}) }}">условия обслуживания сайта im-kard.ru</a>&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eula" id="eula">
                    </td>
                </tr>
                <tr><td colspan="2"><br /></td></tr>
                <tr>
                    <td></td>
                    <td style="text-align: right">
                        <input type="button" value="Оформить заявку" class="btn">
                    </td>
                </tr>
            </form>
        </table>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("bundles/crmmain/lib/chosen/chosen.jquery.js") }}" type="text/javascript"></script>
    {#<script type="text/javascript"src="{{ asset('bundles/crmmain/javascripts/jquery.customfile.js') }}"></script>#}
    <script src="{{ asset('bundles/crmmain/javascripts/jquery.maskedinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/odyniec/jquery.imgareaselect.min.js') }}" type="text/javascript"></script>


    <script>
        $(document).ready(function(){
            var files;
            $('input, select').styler();
            $('input[type=file]').on('change', prepareUpload);

            $('#rezident').change(function(){
                if ( $(this).val() == '1' ){
                    $('#rus').css('display','table-row');
                    $('#notrus').css('display','none');
                }else{
                    $('#rus').css('display','none');
                    $('#notrus').css('display','table-row');
                }
            });

            $('#sendCoords').click(function(){
                type= 'passport';
                x1 = $('input[name="x1"]').val();
                y1 = $('input[name="y1"]').val();
                x2 = $('input[name="x2"]').val()-x1;
                y2 = $('input[name="y2"]').val()-y1;
                $.ajax({
                    type: "POST",
                    url: Routing.generate('send_coordinates', {'type': type}),
                    data: 'x='+x1+'&y='+y1+'&x2='+x2+'&y2='+y2,
                    success: function(msg){
                        $('#img-pop-up-img').html('<div style="display: inline-block"><img src="'+msg+'" /></div>');
                        $(".imgareaselect-selection").parent().remove();
                        $(".imgareaselect-outer").remove();
                        hideImgPopUp();
//                        getImgData('passport');
                    }
                });
            });

            function progressHandlingFunction(e){
                if(e.lengthComputable){
                    $('progress').attr({value:e.loaded,max:e.total});
                }
            }
            function showImgPopUp(){
                $('.bg-gray').fadeIn();
                $('.img-pop-up').fadeIn();
                $('input, select').styler();
            }

            function hideImgPopUp(){
                $('.bg-gray').fadeOut();
                $('.img-pop-up').fadeOut();
            }

            function prepareUpload(event){
                files = event.target.files;
                var formData = new FormData();
                $.each(files, function(key, value){
                    formData.append(key, value);
                });
                type = 'passport';
                $.ajax({
                    url: Routing.generate('uploadDoc', {'type': type}),
                    type: 'POST',
                    xhr: function() {
                        var myXhr = $.ajaxSettings.xhr();
                        if(myXhr.upload){
                            myXhr.upload.addEventListener('#progress-passport',progressHandlingFunction, false);
                        }
                        return myXhr;
                    },
                    //beforeSend: ,
                    //error: ,
                    success: function(msg){
                        $('#img-pop-up-img').html('<div style="display: inline-block"><img  src="'+msg+'" /></div>');
                        showImgPopUp();
                        $('#img-pop-up-img div img').imgAreaSelect({
                            x1: 120, y1: 90, x2: 280, y2: 210,
                            handles: true,
                            onSelectEnd: function (img, selection) {
                                $('input[name="x1"]').val(selection.x1);
                                $('input[name="y1"]').val(selection.y1);
                                $('input[name="x2"]').val(selection.x2);
                                $('input[name="y2"]').val(selection.y2);
                            }
                        });
                    },
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }
        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('bundles/crmmain/lib/chosen/chosen.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/odyniec/distfiles/css/imgareaselect-default.css') }}" rel="stylesheet" media="all">
    <style>
        progress{
            display: none;
        }
        .img-pop-up{
            position: absolute;
            width: 700px;
            max-height: 700px;
            min-height: 300px;
            background: #ffffff;
            border: 1px solid #ae3538;
            left: 50%;
            top: 50px;
            margin-left: -350px;
            z-index: 905;
            display: none;
            text-align: center;
        }
        #img-pop-up-img div{
            width: 680px;
        }
        #img-pop-up-img div img{
            max-width: 680px;
            max-height: 400px;
        }
        .bg-gray{
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #555555;
            opacity: 0.3;
            z-index: 900;
            display: none;
        }
        .img-pop-up-title, .img-pop-up-nav{
            text-align: center;
            padding: 10px;
            max-width: 680px;
        }
        .label-text{
            /*margin-top: -15px;*/
        }
        .label{
            width: 315px;
        }
        form{
            margin: 0;
        }
        .empty-row{
            border-top: 1px solid #CCC;
            border-bottom: 1px solid #CCC;
            padding: 30px 10px 10px 10px;
            font-weight: bold;
        }
        .empty-row-border{
            border: 1px solid #CCCCCC;
        }
        .required{
            color: #CC0000;
        }
    </style>
{% endblock %}