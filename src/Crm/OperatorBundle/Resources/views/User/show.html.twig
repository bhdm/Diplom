{% extends 'CrmOperatorBundle::layout.html.twig' %}


{% block crosh %}
    <a href="{{ path('operator_main') }}">Главная</a> &raquo;
    <a href="{{ path('operator_company_list') }}">Пользователи</a> &raquo;
    <a href="#">{{ user }}</a>
{% endblock %}

{% block content %}

    <div class="bg-gray"></div>
    <div class="img-pop-up ui-widget-content">
        <div class="img-pop-up-title">
            выберите область с документом. При необходимости переверните фото.
        </div>
        <div id="img-pop-up-img"></div>
        <img src="{{ asset('bundles/crmmain/images/close_ico.png') }}" class="close-pop-up ico" />
        <div class="img-pop-up-nav">
            <input type="hidden" name="x1" id="x1" value="0">
            <input type="hidden" name="y1" id="y1" value="0">
            <input type="hidden" name="x2" id="x2" value="0">
            <input type="hidden" name="y2" id="y2" value="0">
            <input type="button" value="Выбрать" id="sendCoords" class="btn">
            <input type="button" value="Повернуть"  class="btn" id="rotate">
            <input type="button" value="Вперед"  id="forward" class="btn" style="display: none;">
        </div>
    </div>
    <div id="loader"></div>

    <form method="post">
        <table class="table-edit">
            <tr>
                <td colspan="3">
                    <div class="error-msg-p"></div>
                </td>
            </tr>
            <tr>
                <td class="label">E-mail:</td>
                <td class="value">
                    <input name="email" id="email" type="text" placeholder="Укажите email почту" required  value="{{ user.email }}">
                </td>
                <td class="emailStatus" rowspan="2" style="padding-left: 10px; font-size: 12px">
                    <i>Необходимо заполнить хотя бы одно из полей - Email или телефон</i>
                </td>
            </tr>
            <tr>
                <td class="label">Телефон:</td>
                <td class="value">
                    <input name="phone" id="phone" type="text" placeholder="Укажите телефон" value="{{ user.phone }}">
                </td>
            </tr>
            <tr>
                <td class="label">Гражданство<span class="required">*</span>:</td>
                <td class="value">
                    <select name="rezident" id="rezident">
                        <option value="1">Россия</option>
                        <option value="2">Другое</option>
                    </select>
                </td>
                <td ></td>
            </tr>
            <tr>
                <td class="label">Номер прошлой карты:</td>
                <td class="value">
                    <input name="oldNumber" id="oldNumber" type="text" placeholder="Номер прошлой карты">
                </td>
            </tr>
            <tr>
                <td class="empty-row">Паспортные данные</td>
                <td class="value">
                    <input type="file" name="passport" id="passport">
                </td>
                <td rowspan="10" class="copyDocs">
                    <img src="/{{ user.copyPassport.path }}">
                </td>
            </tr>
            <tr>
                <td class="label">Фамилия<span class="required">*</span>:</td>
                <td class="value">
                    <input name="lastName" id="lastName" type="text" value="{{ user.lastName }}">
                </td>
            </tr>
            <tr>
                <td class="label">Имя<span class="required">*</span>:</td>
                <td class="value">
                    <input name="firstName" id="firstName" type="text" value="{{ user.firstName }}" >
                </td>

            </tr>
            <tr>
                <td class="label">Отчество:</td>
                <td class="value">
                    <input name="surName" id="surName" type="text" value="{{ user.surName }}">
                </td>

            </tr>
            <tr>
                <td class="label">Дата рождения<span class="required">*</span>:</td>
                <td class="value">
                    <input name="birthdate" id="birthdate" type="text" value="{{ user.birthDate | date('d.m.Y') }}">
                </td>

            </tr>
            <tr>
                <td class="label">Серия паспорта:</td>
                <td class="value">
                    <input name="passportSeries" id="passportSeries" type="text"  data-placeholder="Для паспорта РФ">
                </td>

            </tr>
            <tr>
                <td class="label">Номер паспорта<span class="required">*</span>:</td>
                <td class="value">
                    <input name="passportNumber" id="passportNumber" type="text"  value="{{ user.passportNumber }}">
                </td>

            </tr>
            <tr>
                <td class="label">Кем выдан<span class="required">*</span>:</td>
                <td class="value">
                    <input name="passportPlace" id="passportPlace" type="text"  value="{{ user.passportIssuance }}">
                </td>

            </tr>
            <tr>
                <td class="label">Дата выдачи<span class="required">*</span>:</td>
                <td class="value">
                    <input name="passportDate" id="passportDate" type="text"  value="{{ user.passportIssuanceDate | date('d.m.Y') }}">
                </td>

            </tr>
            <tr>
                <td class="label">Код подразделения:</td>
                <td class="value">
                    <input name="passportCode" id="passportCode" type="text"  value="{{ user.passportCode }}">
                </td>

            </tr>


            <tr>
                <td class="empty-row">Водительские права</td>
                <td class="value">
                    <input type="file" name="driver" id="driver">
                </td>
                <td rowspan="5" class="copyDocs">
                    <img src="/{{ user.copyDriverPassport.path }}">
                </td>
            </tr>
            <tr>
                <td class="label">Кем выдан:</td>
                <td class="value">
                    <input name="driverDocIssuance" id="driverDocIssuance" type="text"  value="{{ user.driverDocIssuance }}">
                </td>
            </tr>
            <tr>
                <td class="label">Номер удостоверения водителя:</td>
                <td class="value">
                    <input name="driverNumber" id="driverNumber" type="text"  value="{{ user.driverDocNumber }}">
                </td>

            </tr>
            <tr>
                <td class="label">Дата выдачи:</td>
                <td class="value">
                    <input name="driverDateStarts" id="driverDateStarts" type="text"  value="{{ user.driverDocDateStarts | date('d.m.Y')}}">
                </td>

            </tr>
            <tr>
                <td class="label">Дата окончания:</td>
                <td class="value">
                    <input name="driverDateEnds" id="driverDateEnds" type="text"  value="{{ user.driverDocDateEnds | date('d.m.Y')}}" >
                </td>

            </tr>


            <tr>
                <td class="empty-row">С Н И Л С</td>
                <td class="value">
                    <input type="file" name="snils" id="snils">
                </td>
                <td class="copyDocs" rowspan="2">
                    <img src="/{{ user.copySnils.path }}">
                </td>
            </tr>
            <tr>
                <td class="label">Страховой номер лицевого счета</td>
                <td class="value">
                    <input name="snils" id="snils" type="text"  value="{{ user.snils }}">
                </td>
            </tr>

            <tr><td colspan="2" class="empty-row">Другие прикрепленные файлы</td></tr>
            <tr>
                <td class="label">Фотография</td>
                <td class="value copyDocs" colspan="2">
                    <img src="/{{ user.photo.path }}">
                </td>
            </tr>
            {% if user.copyPetition.path is defined %}
                <tr>
                    <td class="label">Ходатайство</td>
                    <td class="value copyDocs" colspan="2">
                        <img src="/{{ user.copyPetition.path }}">
                    </td>
                </tr>
            {% endif %}
            {% if user.copyWork.path is defined %}
                <tr>
                    <td class="label">Разрешение на работу</td>
                    <td class="value copyDocs" colspan="2">
                        <img src="/{{ user.copyWork.path }}">
                    </td>
                </tr>
            {% endif %}
            <tr>
                <td colspan="2">
                    <i style="font-size: 14px; color: #CC3333">* Поля отмеченные звездочкой обязательны для заполнения</i>
                    <br />
                </td>
            </tr>
            <tr>
                <td></td>
                <td style="text-align: right">
                    <input type="button" value="Сохранить" class="btn" id="submit">
                </td>
            </tr>
        </table>
    </form>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .empty-row{
            font-weight: bold;
        }

        .copyDocs{
            vertical-align: top;
        }
        .copyDocs img{
            margin-left: 10px;
            max-width: 410px;
            max-height: 400px;
        }
        td{
            vertical-align: top;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/crmmain/lib/odyniec/jquery.imgareaselect.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/javascripts/spin.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/jquery-ui/jquery-ui.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/fancyapps/jquery.fancybox.js') }}" type="text/javascript"></script>
    <script>
        $(document).ready(function(){
            $('input, select').styler();
            $("#phone").mask("+7 (999) 999-9999");
            $("#passportCode").mask("999-999");
            $.mask.definitions['d'] = "[a-zA-Z0-9а-яА-Я ]";
            $('#driverNumber').mask("dddd999999");
            $("#driverDateStarts").mask("99.99.9999");
            $("#driverDateEnds").mask("99.99.9999");
            $("#birthdate").mask("99.99.9999");
            $("#passportDate").mask("99.99.9999");
            var files;
            var opts = {
                lines: 13, // The number of lines to draw
                length: 20, // The length of each line
                width: 10, // The line thickness
                radius: 30, // The radius of the inner circle
                corners: 1, // Corner roundness (0..1)
                rotate: 0, // The rotation offset
                direction: 1, // 1: clockwise, -1: counterclockwise
                color: '#000', // #rgb or #rrggbb or array of colors
                speed: 1.3, // Rounds per second
                trail: 60, // Afterglow percentage
                shadow: false, // Whether to render a shadow
                hwaccel: false, // Whether to use hardware acceleration
                className: 'spinner', // The CSS class to assign to the spinner
                zIndex: 2e9, // The z-index (defaults to 2000000000)
                top: '50%', // Top position relative to parent
                left: '50%' // Left position relative to parent
            };
            var target = document.getElementById('loader');
            var spinner = new Spinner(opts).spin(target);


            //Загрузка нового файла

            $('input[type=file]').on('change', function(event){
                $('.bg-gray').fadeIn();
                $('#loader').fadeIn();

                $('.img-pop-up').attr('type-doc', $(this).attr('name'));


                files = event.target.files;
                var formData = new FormData();
                $.each(files, function(key, value){
                    formData.append(key, value);
                });
                if ($('.img-pop-up').attr('type-doc') != ''){
                    type = $('.img-pop-up').attr('type-doc');
                    $.ajax({
                        url: Routing.generate('uploadDoc', {'type': type}),
                        type: 'POST',
                        xhr: function() {
                            var myXhr = $.ajaxSettings.xhr();
                            if(myXhr.upload){
                                myXhr.upload.addEventListener('#progress-passport',progressHandlingFunction, false);
                            }
                            return myXhr;
                        },
                        //beforeSend: ,
                        //error: ,
                        success: function(msg){

                            $('.bg-gray').fadeOut();
                            $('#loader').fadeOut();

                            if ($('.img-pop-up').attr('type-doc') != 'work' ){
                                $('#img-pop-up-img').html('<div style="display: inline-block"><img  src="'+msg+'" /></div>');
                                showImgPopUp();
                                if ( type == 'photo'){
                                    $('#img-pop-up-img div img').imgAreaSelect({
                                        aspectRatio: '3:4',
                                        handles: true,
                                        onSelectEnd: function (img, selection) {
                                            $('input[name="x1"]').val(selection.x1);
                                            $('input[name="y1"]').val(selection.y1);
                                            $('input[name="x2"]').val(selection.x2);
                                            $('input[name="y2"]').val(selection.y2);
                                            $('.imgareaselect-selection').addClass('imgareaselect-selection2');
                                        }
                                    });
                                }else{
                                    $('#img-pop-up-img div img').imgAreaSelect({
                                        x1: 120, y1: 90, x2: 280, y2: 210,
                                        handles: true,
                                        onSelectEnd: function (img, selection) {
                                            $('input[name="x1"]').val(selection.x1);
                                            $('input[name="y1"]').val(selection.y1);
                                            $('input[name="x2"]').val(selection.x2);
                                            $('input[name="y2"]').val(selection.y2);
                                        }
                                    });
                                }
                            }
                        },
//                        error:function (error) {
//                            alert("error"+error);
//                        },
                        data: formData,
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }
                if ( $('#signFile-styler').children('.jq-file__name').html() == 'Файл не выбран'){
                    hideloader();
                    hideImgPopUp();
                }
            });


            $('#rotate').click(function(){
                type = $('.img-pop-up').attr('type-doc');
                $.ajax({
                    type: "POST",
                    url: Routing.generate('rotate-image', {'type': type}),
                    success: function(msg){
                        $(".imgareaselect-selection").parent().remove();
                        $(".imgareaselect-outer").remove();
                        $('#img-pop-up-img').html('<div style="display: inline-block"><img  src="'+msg+'" /></div>');
                        showImgPopUp();
                        if ( type == 'photo'){
                            $('#img-pop-up-img div img').imgAreaSelect({
                                aspectRatio: '3:5',
//                                x1: 120, y1: 90, x2: 280, y2: 210,
                                handles: true,
                                onSelectEnd: function (img, selection) {
                                    $('input[name="x1"]').val(selection.x1);
                                    $('input[name="y1"]').val(selection.y1);
                                    $('input[name="x2"]').val(selection.x2);
                                    $('input[name="y2"]').val(selection.y2);
                                }
                            });
                            $('.imgareaselect-selection').addClass('imgareaselect-selection2');
                        }else{
                            $('#img-pop-up-img div img').imgAreaSelect({
                                x1: 120, y1: 90, x2: 280, y2: 210,
                                handles: true,
                                onSelectEnd: function (img, selection) {
                                    $('input[name="x1"]').val(selection.x1);
                                    $('input[name="y1"]').val(selection.y1);
                                    $('input[name="x2"]').val(selection.x2);
                                    $('input[name="y2"]').val(selection.y2);
                                }
                            });
                        }

                    }
                });
            });









            function showImgPopUp(){
                $('.bg-gray').fadeIn();
                $('.img-pop-up').fadeIn();
            }

            function hideImgPopUp(){
                $('.bg-gray').fadeOut();
                $('.img-pop-up').fadeOut();
            }

            function hideloader(x){
                if (x == 1)
                    showInpPopUp();
                $('.bg-gray').fadeOut();
                $('#loader').fadeOut();
            }

            function showloader(){
                hideInpPopUp();
                $('.bg-gray').fadeIn();
                $('#loader').fadeIn();
            }

        });




    </script>
{% endblock %}