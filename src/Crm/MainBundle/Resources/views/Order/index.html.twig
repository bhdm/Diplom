{% extends 'CrmMainBundle::layout.html.twig' %}

{% block content %}
    <div class="box">
        <h2>Оформление заявки</h2>
    </div>
    <div class="bg-gray"></div>
    <div class="img-pop-up">
        <div class="img-pop-up-title">
            выберите область с документом. При необходимости переверните фото.
        </div>
        <div id="img-pop-up-img"></div>
        <div class="img-pop-up-nav">
            <input type="hidden" name="x1" id="x1">
            <input type="hidden" name="y1" id="y1">
            <input type="hidden" name="x2" id="x2">
            <input type="hidden" name="y2" id="y2">
            <input type="button" value="Выбрать" id="sendCoords">
            <input type="button" value="Повернуть">
        </div>
    </div>

    <div class="box">
        <table>
            <form method="POST" action="{{ path('order_confirmation') }}" id="main-form">
            <tr>
                <td class="label">E-mail<span class="required">*</span>:</td>
                <td class="value">
                        <input name="email" id="email" type="text" placeholder="Укажите вашу почту" required>
                </td>
                <td class="emailStatus"></td>
            </tr>
            <tr>
                <td class="label">Телефон:</td>
                <td class="value">
                    <input name="phone" id="phone" type="text" placeholder="Укажите ваш телефон">
                </td>
                <td class="phoneStatus"></td>
            </tr>
            <tr>
                <td class="label">Гражданство<span class="required">*</span>:</td>
                <td class="value">
                    <select name="rezident" id="rezident">
                        <option value="1">гражданин РФ</option>
                        <option value="2">иностранный гражданин</option>
                    </select>
                </td>
                <td ></td>
            </tr>
                <tr><td colspan="2" class="empty-row">Организация</td></tr>
            <tr>
                <td class="label">Название организации<span class="required">*</span>:</td>
                <td class="value">
                    <input name="phone" id="companyName" type="text" placeholder=""  required>
                </td>
                <td class="companyNameStatus"></td>
            </tr>
            <tr>
                <td class="label">Адрес организации<span class="required">*</span>:</td>
                <td class="value">
                    <input name="companyZipcode" id="companyZipcode"  type="text" placeholder="Индекс"  required><br />
                    <input name="companyRegion"  id="companyRegion"   type="text" placeholder="регион" required ><br />
                    <input name="companyCity"    id="companyCity"     type="text" placeholder="Город" required><br />
                    <input name="companyStreet"  id="companyStreet"   type="text" placeholder="Улица"><br />
                    <input name="companyHouse"   id="companyHouse"    type="text" placeholder="Дом" class="little" required>
                    <input name="companyCorp"    id="companyCorp"     type="text" placeholder="Корп /Стр"  class="little">
                    <input name="companyRoom"    id="companyRoom"     type="text" placeholder="Кв / оф"  class="little">
                </td>
                <td class="companyAdressStatus"></td>
            </tr>
            <tr><td colspan="2" class="empty-row">Другая информация</td></tr>
            <tr>
                <td class="label">Номер прошлой карты:</td>
                <td class="value">
                    <input name="oldNumber" id="oldNumber" type="text"  >
                </td>
                <td class="oldNumberStatus"></td>
            </tr>
            <tr><td colspan="2" class="empty-row">Информация о доставке</td></tr>
            <tr>
                <td class="label">Адрес доставки<span class="required">*</span>:</td>
                <td class="value">
                    <input name="deliveryZipcode" id="deliveryZipcode" type="text" placeholder="Индекс" required><br />
                    <input name="deliveryRegion"  id="deliveryRegion"  type="text" placeholder="регион" required><br />
                    <input name="deliveryCity"    id="deliveryCity"    type="text" placeholder="Город" required><br />
                    <input name="deliveryStreet"  id="deliveryStreet"  type="text" placeholder="Улица"><br />
                    <input name="deliveryHouse"   id="deliveryHouse"   type="text" placeholder="Дом" class="little" required>
                    <input name="deliveryCorp"    id="deliveryCorp"    type="text" placeholder="Корп /Стр"  class="little">
                    <input name="deliveryRoom"    id="deliveryRoom"    type="text" placeholder="Кв / оф"  class="little">
                </td>
                <td class="deliveryAdressStatus"></td>
            </tr>
            </form>
            <tr><td colspan="2" class="empty-row">Документы</td></tr>
            <tr>
                <td class="label">
                    <div class="label-text">Копия паспорта<span class="required">*</span>:</div>
                </td>
                <td class="value">
                    <form enctype="multipart/form-data" id="form-1">
                        <input name="passport" id="passportFile" type="file" value="Выбирите файл">
                    </form>
                </td>
                <td class="passportStatus"></td>
            </tr>
            <tr>
                <td class="label">
                    <div class="label-text">Копия водительского удостоверения<span class="required">*</span>:</div>
                </td>
                <td class="value">
                    <form enctype="multipart/form-data" id="form-2">
                        <input name="driver" id="driverFile" type="file" value="Выбирите файл">
                    </form>
                </td>
                <td class="driverStatus"></td>
            </tr>
            <tr id="rus">
                <td class="label">
                    <div class="label-text">Копия СНИЛС:</div>
                </td>
                <td class="value">
                    <form enctype="multipart/form-data" id="form-2">
                        <input name="snils" id="snilsFile" type="file" value="Выбирите файл">
                    </form>
                </td>
                <td class="snilsStatus"></td>
            </tr>
            <tr id="notrus" style="display: none;">
                <td class="label">
                    <div class="label-text">Разрешение на работу:</div>
                </td>
                <td class="value">
                    <form enctype="multipart/form-data" id="form-2">
                        <input name="work" id="workFile" type="file" value="Выбирите файл">
                    </form>
                </td>
                <td class="workStatus"></td>
            </tr>
            <tr><td colspan="2"><br /></td></tr>
            <tr>
                <td></td>
                <td style="text-align: right">
                    <input type="button" value="Далее" class="btn" id="submit">
                </td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("bundles/crmmain/lib/chosen/chosen.jquery.js") }}" type="text/javascript"></script>
    {#<script type="text/javascript"src="{{ asset('bundles/crmmain/javascripts/jquery.customfile.js') }}"></script>#}
    <script src="{{ asset('bundles/crmmain/javascripts/jquery.maskedinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/odyniec/jquery.imgareaselect.min.js') }}" type="text/javascript"></script>


    <script>
        $(document).ready(function(){
            var files;
            $('input, select').styler();
            $('input[type=file]').on('change', prepareUpload);

            $('#submit').click(function(){
                $('#main-form').submit();
            });

            $('#rezident').change(function(){
                if ( $(this).val() == '1' ){
                    $('#rus').css('display','table-row');
                    $('#notrus').css('display','none');
                }else{
                    $('#rus').css('display','none');
                    $('#notrus').css('display','table-row');
                }
            });

            $('#sendCoords').click(function(){
                type= 'passport';
                x1 = $('input[name="x1"]').val();
                y1 = $('input[name="y1"]').val();
                x2 = $('input[name="x2"]').val()-x1;
                y2 = $('input[name="y2"]').val()-y1;
                $.ajax({
                    type: "POST",
                    url: Routing.generate('send_coordinates', {'type': type}),
                    data: 'x='+x1+'&y='+y1+'&x2='+x2+'&y2='+y2,
                    success: function(msg){
                        $('#img-pop-up-img').html('<div style="display: inline-block"><img src="'+msg+'" /></div>');
                        $(".imgareaselect-selection").parent().remove();
                        $(".imgareaselect-outer").remove();
                        hideImgPopUp();
//                        getImgData('passport');
                    }
                });
            });

            function progressHandlingFunction(e){
                if(e.lengthComputable){
                    $('progress').attr({value:e.loaded,max:e.total});
                }
            }
            function showImgPopUp(){
                $('.bg-gray').fadeIn();
                $('.img-pop-up').fadeIn();
                $('input, select').styler();
            }

            function hideImgPopUp(){
                $('.bg-gray').fadeOut();
                $('.img-pop-up').fadeOut();
            }

            function prepareUpload(event){
                files = event.target.files;
                var formData = new FormData();
                $.each(files, function(key, value){
                    formData.append(key, value);
                });
                type = 'passport';
                $.ajax({
                    url: Routing.generate('uploadDoc', {'type': type}),
                    type: 'POST',
                    xhr: function() {
                        var myXhr = $.ajaxSettings.xhr();
                        if(myXhr.upload){
                            myXhr.upload.addEventListener('#progress-passport',progressHandlingFunction, false);
                        }
                        return myXhr;
                    },
                    //beforeSend: ,
                    //error: ,
                    success: function(msg){
                        $('#img-pop-up-img').html('<div style="display: inline-block"><img  src="'+msg+'" /></div>');
                        showImgPopUp();
                        $('#img-pop-up-img div img').imgAreaSelect({
                            x1: 120, y1: 90, x2: 280, y2: 210,
                            handles: true,
                            onSelectEnd: function (img, selection) {
                                $('input[name="x1"]').val(selection.x1);
                                $('input[name="y1"]').val(selection.y1);
                                $('input[name="x2"]').val(selection.x2);
                                $('input[name="y2"]').val(selection.y2);
                            }
                        });
                    },
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }
        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('bundles/crmmain/lib/chosen/chosen.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/odyniec/distfiles/css/imgareaselect-default.css') }}" rel="stylesheet" media="all">
    <style>
        progress{
            display: none;
        }
        .img-pop-up{
            position: absolute;
            width: 700px;
            max-height: 700px;
            min-height: 300px;
            background: #ffffff;
            border: 1px solid #ae3538;
            left: 50%;
            top: 50px;
            margin-left: -350px;
            z-index: 905;
            display: none;
            text-align: center;
        }
        #img-pop-up-img div{
            width: 680px;
        }
        #img-pop-up-img div img{
            max-width: 680px;
            max-height: 400px;
        }
        .bg-gray{
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #555555;
            opacity: 0.3;
            z-index: 900;
            display: none;
        }
        .img-pop-up-title, .img-pop-up-nav{
            text-align: center;
            padding: 10px;
            max-width: 680px;
        }
        .label-text{
            /*margin-top: -15px;*/
        }
        .label{
            width: 315px;
        }
        form{
            margin: 0;
        }
        .empty-row{
            border-top: 1px solid #CCC;
            border-bottom: 1px solid #CCC;
            padding: 30px 10px 10px 10px;
            font-weight: bold;
        }
        .empty-row-border{
            border: 1px solid #CCCCCC;
        }
        .required{
            color: #CC0000;
        }
    </style>
{% endblock %}