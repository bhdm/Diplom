{% extends 'CrmMainBundle::layout.html.twig' %}

{% block content %}
    <div class="box">
        <h2>Оформление заявки</h2>
    </div>
    <div class="bg-gray"></div>
    <div class="img-pop-up">
        <div class="img-pop-up-title">
            выберите область с паспортом. При необходимости переверните фото.
        </div>
        <div id="passport-img"></div>
        <div class="img-pop-up-nav">
            <input type="hidden" name="x1" id="x1">
            <input type="hidden" name="y1" id="y1">
            <input type="hidden" name="x2" id="x2">
            <input type="hidden" name="y2" id="y2">
            <input type="button" value="Сохранить" id="sendCoords">
            <input type="button" value="Повернуть">
        </div>
    </div>

    <div class="form">
        <table>
            <tr>
                <td class="label">
                    <div class="label-text">Выберите пасспорт</div>
                </td>
                <td class="value">
                    <form enctype="multipart/form-data" id="form-1">
                        <input name="passport" id="passportFile" type="file" value="Выбирите файл">
                        <progress id="progress-passport"></progress>
                    </form>
                </td>
            </tr>
            <tr class="passportFields">
                <td class="label">Фамилия</td>
                <td class="value"><input type="text" name="passportLastName" id="passportLastName"></td>
            </tr>
            <tr class="passportFields">
                <td class="label">Имя</td>
                <td class="value"><input type="text" name="passportFirstName" id="passportFirstName"></td>
            </tr>
            <tr class="passportFields">
                <td class="label">Отчество</td>
                <td class="value"><input type="text" name="passportSurName" id="passportSurName"></td>
            </tr>
            <tr class="passportFields">
                <td class="label">Дата рождения</td>
                <td class="value"><input type="text" name="passportBirtday" id="passportBirtday"></td>
            </tr>
            <tr class="passportFields">
                <td class="label">Код подразделения</td>
                <td class="value"><input type="text" name="passportCode" id="passportCode"></td>
            </tr>
            <tr class="passportFields">
                <td class="label">Серия и номер</td>
                <td class="value"><input type="text" name="passportNumber" id="passportNumber"></td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("bundles/crmmain/lib/chosen/chosen.jquery.js") }}" type="text/javascript"></script>
    {#<script type="text/javascript"src="{{ asset('bundles/crmmain/javascripts/jquery.customfile.js') }}"></script>#}
    <script src="{{ asset('bundles/crmmain/javascripts/jquery.maskedinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/odyniec/jquery.imgareaselect.min.js') }}" type="text/javascript"></script>


    <script>
        $(document).ready(function(){
            var files;
            $('input, select').styler();
            $('input[type=file]').on('change', prepareUpload);


            $('#sendCoords').click(function(){
                type= 'passport';
                x1 = $('input[name="x1"]').val();
                y1 = $('input[name="y1"]').val();
                x2 = $('input[name="x2"]').val()-x1;
                y2 = $('input[name="y2"]').val()-y1;
                $.ajax({
                    type: "POST",
                    url: Routing.generate('send_coordinates', {'type': type}),
                    data: 'x='+x1+'&y='+y1+'&x2='+x2+'&y2='+y2,
                    success: function(msg){
                        $('#passport-img').html('<div style="display: inline-block"><img id="passport-img-img" src="'+msg+'" /></div>');
                        $(".imgareaselect-selection").parent().remove();
                        $(".imgareaselect-outer").remove();
                        hideImgPopUp();
                        getImgData('passport');
                    }
                });
            });

            function progressHandlingFunction(e){
                if(e.lengthComputable){
                    $('progress').attr({value:e.loaded,max:e.total});
                }
            }
            function showImgPopUp(){
                $('.bg-gray').fadeIn();
                $('.img-pop-up').fadeIn();
                $('input, select').styler();
            }

            function hideImgPopUp(){
                $('.bg-gray').fadeOut();
                $('.img-pop-up').fadeOut();
            }

            function prepareUpload(event){
                files = event.target.files;
                var formData = new FormData();
                $.each(files, function(key, value){
                    formData.append(key, value);
                });

                $.ajax({
                    url: '{{ path('uploadPassport') }}',
                    type: 'POST',
                    xhr: function() {
                        var myXhr = $.ajaxSettings.xhr();
                        if(myXhr.upload){
                            myXhr.upload.addEventListener('#progress-passport',progressHandlingFunction, false);
                        }
                        return myXhr;
                    },
                    //beforeSend: ,
                    //error: ,
                    success: function(msg){
                        $('#passport-img').append('<div style="display: inline-block"><img id="passport-img-img" src="'+msg+'" /></div>');
                        showImgPopUp();
                        $('#passport-img-img').imgAreaSelect({
                            x1: 120, y1: 90, x2: 280, y2: 210,
                            handles: true,
                            onSelectEnd: function (img, selection) {
                                $('input[name="x1"]').val(selection.x1);
                                $('input[name="y1"]').val(selection.y1);
                                $('input[name="x2"]').val(selection.x2);
                                $('input[name="y2"]').val(selection.y2);
                            }
                        });
                    },
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }

            function getImgData(type){
                $.ajax({
                    type: "POST",
                    url: Routing.generate('get_img_data', {'type': type}),
                    success: function(msg){
                        obj = msg
                        obj = obj.data;
                        $('#passportLastName').val(obj.lastName);
                        $('#passportFirstName').val(obj.firstName);
                        $('#passportSurName').val(obj.surName);
                        $('#passportBirtday').val(obj.passportDate);
                        $('#passportCode').val(obj.passportCode);
                        $('#passportNumber').val(obj.passportNumber);
                        $('.passportFields').css('display','table-row');
                    }
                });
            }

        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('bundles/crmmain/lib/chosen/chosen.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/odyniec/distfiles/css/imgareaselect-default.css') }}" rel="stylesheet" media="all">
    <style>
        progress{
            display: none;
        }
        .img-pop-up{
            position: absolute;
            width: 700px;
            max-height: 700px;
            min-height: 300px;
            background: #ffffff;
            border: 1px solid #ae3538;
            left: 50%;
            top: 100px;
            margin-left: -350px;
            z-index: 905;
            display: none;
            text-align: center;
        }
        .img-pop-up img{
            /*padding: 25px;*/
        }
        .bg-gray{
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #555555;
            opacity: 0.3;
            z-index: 900;
            display: none;
        }
        .img-pop-up-title, .img-pop-up-nav{
            text-align: center;
            padding: 10px;
        }
        .label-text{
            margin-top: -15px;
        }
        .passportFields{
            display: none;
        }
    </style>
{% endblock %}