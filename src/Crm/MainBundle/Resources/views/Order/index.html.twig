{% extends 'CrmMainBundle::layout.html.twig' %}

{% block content %}
    <div class="box">
        <h2>Оформление заявки</h2>
    </div>
    <div class="bg-gray"></div>
    <div class="img-pop-up">
        <div class="img-pop-up-title">
            выберите область с паспортом. При необходимости переверните фото.
        </div>
        <div id="passport-img"></div>
        <div class="img-pop-up-nav">
            <input type="button" value="Сохранить">
            <input type="button" value="Повернуть">
        </div>
    </div>

    <div class="form">
        <table>
            <tr>
                <td class="label">Выберите пасспорт</td>
                <td class="value">
                    <form enctype="multipart/form-data" id="form-1">
                        <input name="passport" id="passportFile" type="file" value="Выбирите файл">
                        <progress id="progress-passport"></progress>
                    </form>
                </td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("bundles/crmmain/lib/chosen/chosen.jquery.js") }}" type="text/javascript"></script>
    {#<script type="text/javascript"src="{{ asset('bundles/crmmain/javascripts/jquery.customfile.js') }}"></script>#}
    <script src="{{ asset('bundles/crmmain/javascripts/jquery.maskedinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/crmmain/lib/odyniec/jquery.imgareaselect.min.js') }}" type="text/javascript"></script>


    <script>
        $(document).ready(function(){
            var files;
            $('input, select').styler();
            $('input[type=file]').on('change', prepareUpload);

            function progressHandlingFunction(e){
                if(e.lengthComputable){
                    $('progress').attr({value:e.loaded,max:e.total});
                }
            }
            function showImgPopUp(){
                $('.bg-gray').fadeIn();
                $('.img-pop-up').fadeIn();
                $('input, select').styler();
            }

            function prepareUpload(event)
            {
                files = event.target.files;
                var formData = new FormData();
                $.each(files, function(key, value){
                    formData.append(key, value);
                });

                $.ajax({
                    url: '{{ path('uploadPassport') }}',
                    type: 'POST',
                    xhr: function() {
                        var myXhr = $.ajaxSettings.xhr();
                        if(myXhr.upload){
                            myXhr.upload.addEventListener('#progress-passport',progressHandlingFunction, false);
                        }
                        return myXhr;
                    },
                    //beforeSend: ,
                    //error: ,
                    success: function(msg){
                        $('#passport-img').append('<img src="'+msg+'" />');
                        showImgPopUp();
                        $('#passport-img img').imgAreaSelect({
                            handles: true
//                            onSelectEnd: someFunction
                        });
                    },
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }



        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('bundles/crmmain/lib/chosen/chosen.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/styler/jquery.formstyler.css') }}" rel="stylesheet" media="all">
    <link href="{{ asset('bundles/crmmain/lib/odyniec/distfiles/css/imgareaselect-default.css') }}" rel="stylesheet" media="all">
    <style>
        progress{
            display: none;
        }
        .img-pop-up{
            position: absolute;
            width: 700px;
            max-height: 700px;
            min-height: 300px;
            background: #ffffff;
            border: 1px solid #ae3538;
            left: 50%;
            top: 100px;
            margin-left: -350px;
            z-index: 905;
            display: none;
        }
        .img-pop-up img{
            width: 650px;
            max-height: 560px;
            padding: 25px;
        }
        .bg-gray{
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #555555;
            opacity: 0.3;
            z-index: 900;
            display: none;
        }
        .img-pop-up-title, .img-pop-up-nav{
            text-align: center;
            padding: 10px;
        }
    </style>
{% endblock %}